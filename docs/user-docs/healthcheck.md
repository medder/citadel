## 健康检查

每一个 ERU 节点上都运行了 eru-agent, 它会进行频密的健康检查(健康检查的行为细节需要参考 eru-agent 相应的设置项), 如果发现容器不健康, 会立刻报警并且从 ELB 上下线, 使其停止对外服务. 如果容器恢复健康, 则立刻重新上线 ELB.

任何应用只要声明了 ports, 就意味着这个应用是需要挂载到 ELB 上接受流量的, 所以 core 在部署的时候, 会免费赠送 tcp 健康检查, 也就是说容器启动以后, 只要 eru-agent 进行 TCP 拨号成功, 就认为该容器健康, 这个条件对于某些应用可能并不足够, 比如一些 java 应用啊, 虽然开始监听端口了, 但是其实还是处于初始化状态, 不能接受流量. 这种时候就需要在 `app.yaml` 里声明 HTTP 健康检查了.

一种更加特殊的情况就是, 应用本身的健康检查接口与接收线上流量的接口并不在同一个端口, 这种情况 ERU 目前也做了支持, 允许在 `app.yaml` 里声明 `healthcheck_port`, 但是并不推荐这种做法, `healthcheck_port` 在未来也可能放弃支持.  因为 ELB 关心的仅仅是容器暴露出来的端口能否正常响应线上流量, 所以用来做健康检查的端口按理说也应该是用来处理线上流量的端口.

我们还遇到过一种情况, 有些应用虽然提供了健康检查接口, 在这个接口通过了 eru-agent 的健康检查以后, 还有一段"预热"时间, 这段时间内业务接口可能无法响应请求, 或者需要加载一些资源, 导致响应时间特别长, 这种情况实际上代表健康检查接口不能充分地体现应用的健康状态, 我们建议在健康检查接口上增加相应的逻辑, 使其能在应用初始化完成以后, 才返回 HTTP 200. 当然如果应用允许, 也可以直接用一个业务接口作为健康检查接口.
